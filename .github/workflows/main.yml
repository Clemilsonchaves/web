name: Deploy to s3

on:
  push:
    branches:
      - main

env:
  AWS_S3_BUCKET_STATICS: "rocketseat-upload-widget-web-statics"
  AWS_S3_BUCKET_CDN: "rocketseat-upload-widget-web-cdn"
  SOURCE_DIST: "./dist"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Configure node
        id: configure-node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        id: install-pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        id: install-dependencies
        run: |
          pnpm install

      - name: Build app
        id: build-app
        run: |
          pnpm run build

      - name: Configure AWS credentials
        id: configure-aws-credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Sync to S3 statics
        id: sync-files-to-s3-statics
        run: |
          if [ -n "${{ vars.AWS_KMS_KEY_ID }}" ]; then
            aws s3 sync ${{ env.SOURCE_DIST }} s3://${{ env.AWS_S3_BUCKET_STATICS }}/ --delete --exclude "*.git*" --sse aws:kms --sse-kms-key-id "${{ vars.AWS_KMS_KEY_ID }}"
          else
            aws s3 sync ${{ env.SOURCE_DIST }} s3://${{ env.AWS_S3_BUCKET_STATICS }}/ --delete --exclude "*.git*" --sse AES256
          fi

      - name: Validate CDN bucket permissions
        id: validate-cdn-permissions
        run: |
          set -e
          aws sts get-caller-identity
          echo "ci-probe" > /tmp/cdn-permission-probe.txt

          if [ -n "${{ vars.AWS_KMS_KEY_ID }}" ]; then
            if ! aws s3api put-object --bucket ${{ env.AWS_S3_BUCKET_CDN }} --key .ci-permission-probe --body /tmp/cdn-permission-probe.txt --sse aws:kms --ssekms-key-id "${{ vars.AWS_KMS_KEY_ID }}" > /dev/null; then
              echo "::error::Sem permissao para PutObject (ou KMS) no bucket ${{ env.AWS_S3_BUCKET_CDN }}. Garanta s3:PutObject em arn:aws:s3:::${{ env.AWS_S3_BUCKET_CDN }}/* e, se usar KMS, kms:Encrypt/kms:GenerateDataKey na chave configurada."
              exit 1
            fi
          else
            if ! aws s3api put-object --bucket ${{ env.AWS_S3_BUCKET_CDN }} --key .ci-permission-probe --body /tmp/cdn-permission-probe.txt --server-side-encryption AES256 > /dev/null; then
              echo "::error::Sem permissao para PutObject no bucket ${{ env.AWS_S3_BUCKET_CDN }}. Garanta s3:PutObject em arn:aws:s3:::${{ env.AWS_S3_BUCKET_CDN }}/* e, se o bucket exigir criptografia, permita AES256 ou configure AWS_KMS_KEY_ID com permissoes KMS."
              exit 1
            fi
          fi

          aws s3api delete-object --bucket ${{ env.AWS_S3_BUCKET_CDN }} --key .ci-permission-probe > /dev/null || true

      - name: Sync to S3 CDN
        id: sync-files-to-s3-cdn
        run: |
          if [ -n "${{ vars.AWS_KMS_KEY_ID }}" ]; then
            aws s3 cp ${{ env.SOURCE_DIST }} s3://${{ env.AWS_S3_BUCKET_CDN }}/ --recursive --exclude "*.git*" --sse aws:kms --sse-kms-key-id "${{ vars.AWS_KMS_KEY_ID }}"
          else
            aws s3 cp ${{ env.SOURCE_DIST }} s3://${{ env.AWS_S3_BUCKET_CDN }}/ --recursive --exclude "*.git*" --sse AES256
          fi